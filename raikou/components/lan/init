#!/bin/bash
if [ "$LEGACY" == "no" ]; then
    isolate_docker_iface
fi

count=$((TIMEOUT/5))
for _i in $(seq 1 $count); do
    if ! find /sys/class/net | grep -q -w eth1 ; then
        echo "eth1 interface not found"
        sleep 5
        continue
    fi
    break
done

# Start DHCP client on eth1 to get IP from RPi's dnsmasq
dhclient -v eth1

# Wait for eth1 to get an IP address
count=0
while [ $count -lt 30 ]; do
    if ip addr show eth1 | grep -q "inet "; then
        echo "eth1 has IP address"
        break
    fi
    echo "Waiting for eth1 to get IP address..."
    sleep 1
    count=$((count + 1))
done

# Get eth1 IP address for Dante external binding
ETH1_IP=$(ip addr show eth1 | grep "inet " | awk '{print $2}' | cut -d/ -f1)
if [ -z "$ETH1_IP" ]; then
    echo "Warning: eth1 has no IP address, using interface name"
    EXTERNAL="eth1"
else
    echo "Using eth1 IP address: $ETH1_IP"
    EXTERNAL="$ETH1_IP"
fi

cat > /etc/danted.conf << EOF
logoutput: stderr
internal: 0.0.0.0 port = 8080
external: $EXTERNAL
clientmethod: none
socksmethod: username none #rfc931
user.privileged: root
user.unprivileged: nobody
user.libwrap: nobody
client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect error
}
socks pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect error
}
EOF

service tftpd-hpa start
service lighttpd start
service danted start

/usr/sbin/sshd -D
