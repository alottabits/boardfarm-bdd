# Property Validation Findings - Phase 8

**Date**: December 12, 2025  
**Status**: ‚ö†Ô∏è **Critical Gap Identified**

---

## Executive Summary

Inspection of `fsm_graph.json` reveals that **31 out of 32 states** have incomplete fingerprints due to seeding from `ui_map.json`. Only URL patterns are being used for state matching, defeating the multi-dimensional fingerprinting approach.

---

## Current State Property Capture

### Fingerprint Schema (Designed)

```python
fingerprint = {
    "url_pattern": str,              # ‚úÖ Captured
    "dom_structure_hash": str,       # ‚ùå NULL (seeded states)
    "visible_components": list[str], # ‚ùå NULL (seeded states)
    "page_state": dict,              # ‚ùå NULL (seeded states)
    "key_elements": list[dict],      # ‚ö†Ô∏è Empty (seeded states)
    "title": str                     # ‚úÖ Captured
}
```

### Actual Capture Rate

| Property | Discovered States | Seeded States | Total Coverage |
|----------|-------------------|---------------|----------------|
| `url_pattern` | 1/1 (100%) | 31/31 (100%) | 32/32 (100%) ‚úÖ |
| `title` | 1/1 (100%) | 31/31 (100%) | 32/32 (100%) ‚úÖ |
| `dom_structure_hash` | 1/1 (100%) | 0/31 (0%) | 1/32 (3%) ‚ùå |
| `visible_components` | 1/1 (100%) | 0/31 (0%) | 1/32 (3%) ‚ùå |
| `page_state` | 1/1 (100%) | 0/31 (0%) | 1/32 (3%) ‚ùå |
| `key_elements` | 1/1 (populated) | 0/31 (empty) | 1/32 (3%) ‚ùå |

**Result**: Only **1 state (V_LOGIN_FORM_EMPTY)** has complete multi-dimensional fingerprints. The other 31 states rely solely on URL patterns.

---

## Root Cause Analysis

### Code Location: `ui_mbt_discovery.py`, Line 630-634

```python
# UIMapLoader.extract_states() - INCOMPLETE FINGERPRINTS!
fingerprint = {
    "url_pattern": StateFingerprinter._extract_url_pattern(url),
    "title": node.get("title", ""),
    "key_elements": []  # Empty!
}
# Missing: dom_structure_hash, visible_components, page_state
```

### Why This Happens

1. **Seeding from static JSON**: `ui_map.json` is generated by a separate crawler and only contains structural information (URLs, element locators)
2. **No live page access**: Seeding happens before browser launch, so dynamic properties can't be captured
3. **Incomplete conversion**: The `extract_states()` method doesn't populate all fingerprint fields

### Impact on Resilience

**Current State**: Seeded states are **NOT** resilient because they only use URL patterns for matching. This is equivalent to the POM approach.

**Example**: If a URL changes from `#!/admin/config` to `#!/settings/config`, the FSM would consider it a different state, even if:
- DOM structure is identical
- Visible components are the same
- Page functionality is unchanged

---

## Element Locator Analysis

### Current Locator Strategy

**For transitions**, we capture:

```json
{
  "element_type": "link",
  "locators": {
    "text": "Admin",
    "href": "#!/admin"
  }
}
```

**Priority order used** (from code inspection):
1. `text` - Visible text content
2. `href` - Link target (for links)
3. `input_type` + `name` - For form inputs

### Missing Locator Strategies

**Not currently captured** (would improve resilience):
- ‚ùå ARIA role (`role="button"`, `role="link"`)
- ‚ùå ARIA label (`aria-label="Settings"`)
- ‚ùå Data attributes (`data-testid="admin-link"`)
- ‚ùå Relative position (nth button in nav)
- ‚ùå Placeholder text (for inputs)
- ‚ùå Label association (for inputs)

### Locator Resilience Assessment

| Locator Type | Currently Used | Resilience to... | Score |
|--------------|----------------|------------------|-------|
| `text` | ‚úÖ Yes | CSS changes, DOM restructure | Good üëç |
| `href` | ‚úÖ Yes | CSS changes, text changes | Fair üëå |
| `input_type` + `name` | ‚úÖ Yes | CSS changes, label changes | Good üëç |
| ARIA role | ‚ùå No | CSS, text, DOM changes | **Excellent** üåü |
| ARIA label | ‚ùå No | CSS, text, visual changes | **Excellent** üåü |
| data-testid | ‚ùå No | ANY UI changes | **Perfect** ‚≠ê‚≠ê‚≠ê |
| Placeholder | ‚ùå No | Label changes, CSS changes | Good üëç |

---

## Recommendations

### Priority 1: Fix Seeded State Fingerprints

**Option A: Hydrate seeded states during discovery** (RECOMMENDED)
- After seeding, visit each seeded state once
- Capture full fingerprints with live page access
- Update states dict with complete data

**Option B: Don't seed states, discover from scratch**
- Remove seeding functionality
- Start with login state only
- Discover all states with full fingerprints

**Option C: Two-pass approach**
- First pass: Seed for known structure (current)
- Second pass: Hydrate fingerprints for visited states
- Keep unvisited seeds as "low confidence"

### Priority 2: Enhance Element Locators

Add to `StateFingerprinter._create_element_descriptor()`:

```python
locators = {
    "role": element.get_attribute("role"),           # NEW
    "aria_label": element.get_attribute("aria-label"), # NEW
    "test_id": element.get_attribute("data-testid"),  # NEW
    "text": await element.text_content(),
    "name": element.get_attribute("name"),
    "placeholder": element.get_attribute("placeholder"), # NEW
}
```

### Priority 3: Establish Resilience Hierarchy

**State Matching Priority** (most ‚Üí least stable):
1. **Semantic identity** (60% weight)
   - ARIA roles and landmarks
   - Data attributes (testid)
   - Heading hierarchy

2. **Functional identity** (25% weight)
   - Form field names
   - Button text/purpose
   - Key interactive elements

3. **Structural identity** (10% weight)
   - URL pattern
   - Navigation breadcrumbs

4. **Content identity** (4% weight)
   - Visible component types
   - Page title

5. **Style identity** (1% weight)
   - DOM structure hash
   - Element count

**Matching Algorithm**:
- Score = Œ£(property_weight √ó match_score)
- Threshold: ‚â• 70% ‚Üí Same state
- Threshold: 40-70% ‚Üí Similar state (warn)
- Threshold: < 40% ‚Üí Different state

---

## Next Steps

### Immediate (Today)

1. ‚úÖ Document findings (this file)
2. üîß Implement Option A: Hydrate seeded states
3. üß™ Re-run discovery with full fingerprints
4. üìä Verify all 32 states have complete data

### Short-term (This Week)

1. üîß Add ARIA role/label to element locators
2. üîß Add data-testid support
3. üîß Implement resilience hierarchy scoring
4. üß™ Design resilience test scenarios

### Long-term (Next Phase)

1. üî¨ Execute resilience evaluation (Phase 9)
2. üìä Measure FSM vs POM improvement ratio
3. üéØ Make integration decision

---

## Test Plan

### Validation Tests

After implementing fixes:

```bash
cd /home/rjvisser/projects/req-tst/boardfarm-bdd/tests/ui_helpers

# Run discovery with hydration
python ui_mbt_discovery.py \
  --url http://127.0.0.1:3000 \
  --username admin --password admin \
  --seed-map ui_map.json \
  --output fsm_graph_hydrated.json

# Verify fingerprint completeness
jq '[.nodes[] | {
  id: .id, 
  has_components: (.fingerprint.visible_components != null),
  has_page_state: (.fingerprint.page_state != null),
  has_dom_hash: (.fingerprint.dom_structure_hash != null)
}] | group_by(.has_components) | map({complete: .[0].has_components, count: length})' fsm_graph_hydrated.json
```

**Expected Result**:
```json
[
  {"complete": true, "count": 32}
]
```

### Resilience Tests

After property validation complete:

1. **Test 1: CSS Changes Only**
   - Change all CSS classes
   - Re-run discovery
   - Measure: States matched correctly?

2. **Test 2: DOM Restructure**
   - Move elements to different containers
   - Re-run discovery
   - Measure: Transitions still work?

3. **Test 3: Text Changes**
   - Change button text
   - Re-run discovery
   - Measure: Locators adapt?

4. **Test 4: URL Pattern Changes**
   - Change routing structure
   - Re-run discovery
   - Measure: States still identified?

---

## Conclusion

**Current Status**: Multi-dimensional fingerprinting is **partially implemented** but **not fully utilized** due to incomplete seeded state data.

**Impact**: Current FSM resilience ‚âà POM resilience (URL-based only) for 97% of states.

**Priority**: Fix seeded state hydration to unlock full multi-dimensional matching capability.

**Expected Improvement After Fix**: 2-3x better resilience to UI changes (hypothesis).


