# UI Helpers - FSM-Based GUI Testing

**Last Updated**: December 14, 2025  
**Status**: Ready for Implementation

---

## Overview

This directory contains documentation and artifacts for **comprehensive FSM (Finite State Machine) based GUI testing** in boardfarm using Playwright and StateExplorer packages.

### Three Testing Modes

The architecture supports **three distinct testing strategies**, all driven by a single source of truth (`fsm_graph.json`):

| Mode | Purpose | Test Type | Primary Users |
|------|---------|-----------|---------------|
| **1. Functional** | Business goal verification | "Can I reboot a device via GUI?" | BDD test authors |
| **2. Navigation** | Graph structure & resilience | "Can users reach all pages? Any dead ends?" | QA engineers |
| **3. Visual** | Pixel-perfect UI validation | "Has the UI changed visually?" | UI/UX teams |

---

## Documentation

### ğŸ“‹ Implementation Guide (Start Here)

**[`FSM_IMPLEMENTATION_GUIDE.md`](./FSM_IMPLEMENTATION_GUIDE.md)** - Complete implementation guide

- Three-mode architecture overview
- Component specifications with full APIs
- Configuration details
- 4-week, 5-phase implementation plan
- Testing strategies and success metrics
- Troubleshooting guide

**Key Sections**:
- FsmGuiComponent: Generic FSM engine (~1,200 lines)
- PlaywrightSyncAdapter: Browser wrapper (~200 lines)
- GenieAcsGUI: Device-specific interface (~800 lines)

### ğŸš€ Quick Start Guide

**[`FSM_QUICK_START.md`](./FSM_QUICK_START.md)** - Getting started guide

- Environment setup & dependencies
- Installation instructions
- Minimal implementation examples
- Testing examples for each mode
- Troubleshooting

### ğŸ“š API Reference

**[`FSM_API_REFERENCE.md`](./FSM_API_REFERENCE.md)** - API quick reference

- Common operations and code examples
- Mode-specific patterns
- Element finding strategies
- State verification patterns
- Graph analysis methods
- Visual regression methods

---

## Artifacts

### FSM Graph

**`fsm_graph.json`** - FSM state graph generated by aria-discover tool

- Contains UI states with fingerprints
- State transitions and actions
- Element descriptors with roles
- Generated from live GenieACS instance
- **Size**: 360 KB, 10 states, 58 transitions

**Regenerate when needed**:

```bash
cd ~/projects/req-tst/StateExplorer
source .venv/bin/activate

aria-discover --url http://localhost:3000 \
  --username admin \
  --password admin \
  --max-states 100 \
  --output ../boardfarm-bdd/bf_config/gui_artifacts/genieacs/fsm_graph.json
```

---

## Quick Links

### For Implementation

1. Read [`FSM_IMPLEMENTATION_GUIDE.md`](./FSM_IMPLEMENTATION_GUIDE.md)
2. Follow [`FSM_QUICK_START.md`](./FSM_QUICK_START.md) for setup
3. Reference [`FSM_API_REFERENCE.md`](./FSM_API_REFERENCE.md) during coding

### For Testing

**Mode 1 - Functional Testing** (Business Goals):
```python
# BDD step definition
@when("the operator reboots the device via the ACS GUI")
def step_reboot_device(acs, bf_context):
    success = acs.gui.reboot_device_via_gui(bf_context.cpe_id)
    assert success, "Failed to reboot device"
```

**Mode 2 - Navigation Testing** (Graph Validation):
```python
# Pytest test
def test_graph_structure(acs):
    acs.gui.initialize()
    acs.gui.login()
    
    validation = acs.gui.fsm.validate_graph_connectivity()
    assert validation['is_connected'], "Graph not connected"
    assert len(validation['dead_end_states']) == 0, "Found dead ends"
```

**Mode 3 - Visual Regression** (Screenshot Comparison):
```python
# Pytest test
def test_visual_regression(acs):
    acs.gui.initialize()
    acs.gui.login()
    
    result = acs.gui.validate_ui_against_references(threshold=0.99)
    assert result['overall_pass'], f"Visual failures: {result['failed']}"
```

---

## Architecture Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Test Layer                             â”‚
â”‚  â€¢ BDD Steps (Mode 1)                                     â”‚
â”‚  â€¢ Navigation Tests (Mode 2)                              â”‚
â”‚  â€¢ Visual Tests (Mode 3)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Device Layer (GenieAcsGUI)                   â”‚
â”‚  â€¢ Business goal methods (login, reboot, etc.)            â”‚
â”‚  â€¢ STATE_REGISTRY (friendly names â†’ FSM IDs)              â”‚
â”‚  â€¢ Direct FSM access for Modes 2 & 3                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Generic Layer (FsmGuiComponent)                 â”‚
â”‚  â€¢ State management & verification                        â”‚
â”‚  â€¢ Navigation & pathfinding (BFS)                         â”‚
â”‚  â€¢ Element finding (role-based)                           â”‚
â”‚  â€¢ Graph structure analysis                               â”‚
â”‚  â€¢ Screenshot capture & comparison                        â”‚
â”‚  â€¢ Coverage metrics & reporting                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          StateExplorer Packages                           â”‚
â”‚  â€¢ StateComparer: Fingerprint matching                    â”‚
â”‚  â€¢ ElementLocator: Role-based element finding             â”‚
â”‚  â€¢ PlaywrightFingerprinter: State capture                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Concepts

### Single Source of Truth

`fsm_graph.json` drives all three testing modes:
- **States**: Behavioral snapshots with fingerprints
- **Transitions**: Actions that move between states
- **Elements**: Role-based locators (ARIA accessibility)

### Separation of Concerns

| Layer | Responsibility | Generic/Specific |
|-------|---------------|------------------|
| **FsmGuiComponent** | FSM engine, navigation, analysis, screenshots | 100% Generic |
| **GenieAcsGUI** | Business goals, state mappings | Device-Specific |
| **Step Definitions** | BDD scenarios, test assertions | Test-Specific |

### Friendly Names

Tests use friendly names (`login_page`), device class maps to FSM IDs (`V_LOGIN_FORM_EMPTY`):

```python
STATE_REGISTRY = {
    'login_page': 'V_LOGIN_FORM_EMPTY',
    'home_page': 'V_OVERVIEW_PAGE',
    'device_list_page': 'V_DEVICES',
}
```

---

## Configuration

### Boardfarm Config

**File**: `bf_config/boardfarm_config_example.json`

```json
{
  "name": "genieacs",
  "type": "bf_acs",
  "gui_fsm_graph_file": "bf_config/gui_artifacts/genieacs/fsm_graph.json",
  "gui_headless": true,
  "gui_default_timeout": 30,
  "gui_state_match_threshold": 0.80,
  "gui_screenshot_dir": "bf_config/gui_artifacts/genieacs/screenshots",
  "gui_visual_threshold": 0.95,
  "gui_visual_comparison_method": "auto"
}
```

---

## Dependencies

```bash
# Install StateExplorer packages
pip install -e ~/projects/req-tst/StateExplorer/packages/model-resilience-core
pip install -e ~/projects/req-tst/StateExplorer/packages/aria-state-mapper

# Install Playwright and utilities
pip install playwright pillow networkx
playwright install chromium
```

---

## Files to Create

| File | Location | Size | Purpose |
|------|----------|------|---------|
| FsmGuiComponent | `boardfarm3/lib/gui/` | ~1,200 lines | Generic FSM engine (all modes) |
| PlaywrightSyncAdapter | `boardfarm3/lib/gui/` | ~200 lines | Browser wrapper |
| GenieAcsGUI (updated) | `boardfarm3/devices/` | ~800 lines | Device interface + business goals |

---

## Development Workflow

### Phase 1: Setup (Week 1)
- Install dependencies
- Create generic components (FsmGuiComponent, PlaywrightSyncAdapter)
- Unit test coverage: 90%+

### Phase 2: Integration (Week 2)
- Update GenieAcsGUI with STATE_REGISTRY
- Implement business goal methods
- Integration tests

### Phase 3: Testing (Week 3)
- Mode 1: BDD functional tests
- Mode 2: Navigation structure tests
- Mode 3: Visual regression tests

### Phase 4: Documentation (Week 4)
- Update all documentation
- Create examples
- Helper scripts

---

## Testing Strategies

### Mode 1: Functional Testing
**Goal**: Verify business processes work via GUI  
**Example**: "Can I reboot a device using the Reboot button?"  
**Tests**: BDD step definitions  
**Assertions**: Task completion (boolean results)

### Mode 2: Navigation Testing
**Goal**: Validate UI structure and resilience  
**Example**: "Can users reach all admin pages? Are there dead ends?"  
**Tests**: Graph analysis, random walks, coverage metrics  
**Assertions**: Graph connectivity, state reachability

### Mode 3: Visual Regression
**Goal**: Detect unintended visual changes  
**Example**: "Has the login page layout changed?"  
**Tests**: Screenshot comparison  
**Assertions**: Pixel similarity (99% threshold)

---

## Success Metrics

### Code Quality
- 90%+ test coverage for generic components
- 85%+ test coverage for device integration
- Zero linter errors
- Complete type hints

### Testing Capabilities
- **Mode 1**: All business goals testable
- **Mode 2**: 100% state coverage achievable
- **Mode 3**: Pixel-perfect validation

### Performance
- State detection: â‰¥95% accuracy
- Navigation: â‰¥98% success rate
- Visual comparison: <2 seconds per screenshot

---

## Support

### Documentation
- Implementation questions: See [`FSM_IMPLEMENTATION_GUIDE.md`](./FSM_IMPLEMENTATION_GUIDE.md)
- API questions: See [`FSM_API_REFERENCE.md`](./FSM_API_REFERENCE.md)
- Getting started: See [`FSM_QUICK_START.md`](./FSM_QUICK_START.md)

### StateExplorer
- Core docs: `~/projects/req-tst/StateExplorer/docs/`
- Packages: `~/projects/req-tst/StateExplorer/packages/`

### External Tools
- **GraphWalker**: Model-based testing (https://graphwalker.github.io/)
- **yEd**: Graph visualization (https://www.yworks.com/products/yed)
- **Graphviz**: Graph rendering (https://graphviz.org/)

---

## Historical Notes

### Archive

The `archive/` directory contains milestone documentation from the StateExplorer development:
- Phase completion records
- Development history
- Migration notes

These are preserved for historical reference but are not needed for implementation.

---

**Version**: 2.0 - Three-Mode Comprehensive Testing Architecture  
**Status**: Ready for Phase 1 Implementation  
**Last Updated**: December 14, 2025
